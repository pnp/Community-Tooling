<?xml version="1.0" encoding="utf-8" ?>

<inspection>
  <tokens>
    <token name="fun" value="wowee!"/>
  </tokens>

  <rules>
    <rule name="SampleContents" description="Validates the folders/files for a given sample">
      <tokens>
        <token name="whatever" value="$UPPER(@@fun@@)"/>
      </tokens>
      <conditions>
        <fileexists relativepath=""/>
      </conditions>
    </rule>

    <rule name="README_Exists" description="Verifies the README.md file exists">
      <conditions>
        <fileexists path="README.md"/>
        <fileexists path="README.md" matchcase="true" warn="true"/>
      </conditions>
    </rule>

    <rule name="AssetsFolder_Exists" description="Verifies the assets folder exists">
      <conditions>
        <folderexists path="assets"/>
        <folderexists path="assets" matchcase="true" warn="true"/>
      </conditions>
    </rule>

    <rule name="VerifySampleFiles" description="Makes sure base files exist">
      <conditions>
        <run rule="README_Exists"/>
        <run rule="Assets_Exists"/>
      </conditions>
    </rule>

    <rule name="ValidateSample" description="">
      <tokens>
        <token name="SampleKey" value="$IF($STARTSWITH(@@Each@@,#@@),#$DIRECTORYNAME(@@StartingPath@@),#@@Each@@)"/>
        <token name="FolderPath" value="$IF($STARTSWITH(@@ContainerPath@@,#@@),#@@StartingPath@@,#@@ContainerPath@@\@@Each@@)"/>
        <token name="MainJsonPath" value="@@FolderPath@@\@@SampleKey@@.json"/>
        <token name="READMEPath" value="@@FolderPath@@\README.md"/>
        <token name="AssetsPath" value="@@FolderPath@@\assets"/>
        <token name="SampleJsonPath" value="@@AssetsPath@@\sample.json"/>
      </tokens>
      <conditions>
        <fileexists path="@@MainJsonPath@@" failuremessage="Primary Sample JSON not found! (@@SampleKey@@)"/>
        <fileexists path="@@MainJsonPath@@" matchcase="true" warn="true"/>
        <fileexists path="@@READMEPath@@" failuremessage="README not found! (@@SampleKey@@)"/>
        <fileexists path="@@READMEPath@@" matchcase="true" warn="true"/>
        <folderexists path="@@AssetsPath@@" failuremessage="assets folder missing! (@@SampleKey@@)"/>
        <folderexists path="@@AssetsPath@@" matchcase="true" warn="true"/>
        <fileexists path="@@SampleJsonPath@@" failuremssage="sample.json not found! (@@SampleKey@@)"/>
        <fileexists path="@@SampleJsonPath@@" matchcase="true" warn="true"/>
        <or>
          <and>
            <fileexists path="@@AssetsPath@@\screenshot.png"/>
            <fileexists path="@@AssetsPath@@\screenshot.png" matchcase="true" warn="true"/>
          </and>
          <and>
            <fileexists path="@@AssetsPath@@\screenshot.gif"/>
            <fileexists path="@@AssetsPath@@\screenshot.gif" matchcase="true" warn="true"/>
          </and>
        </or>
      </conditions>
    </rule>

    <rule name="ValidateSamples">
      <conditions>
        <foreachfolder path="column-samples" pattern="date*">
          <run rule="ValidateSample"/>
        </foreachfolder>
      </conditions>
    </rule>

    <rule name="Screenshot" description="Verifies at least 1 screenshot exists (either gif or png)">
      <conditions>
        <or>
          <and>
            <fileexists path="assets/screenshot.png"/>
            <fileexists path="assets/screenshot.png" matchcase="true" warn="true"/>
          </and>
          <and>
            <fileexists path="assets/screenshot.gif"/>
            <fileexists path="assets/screenshot.gif" matchcase="true" warn="true"/>
          </and>
        </or>
      </conditions>
    </rule>

    <rule name="TelemetryLink">
      <tokens>
        <token name="SampleKey" value="$IF($STARTSWITH(@@Each@@,#@@),#$DIRECTORYNAME(@@StartingPath@@),#@@Each@@)"/>
        <token name="FolderPath" value="$IF($STARTSWITH(@@ContainerPath@@,#@@),#@@StartingPath@@,#@@ContainerPath@@\@@Each@@)"/>
        <token name="READMEPath" value="@@FolderPath@@\README.md"/>
        <token name="SampleType" value="$IF($CONTAINS(@@FolderPath@@,#\column-samples\),#column,#$IF($CONTAINS(@@FolderPath@@,#\form-samples\),#form,#view))"/>
        <token name="TelemetryTag">
          <![CDATA[<img src="https://telemetry.sharepointpnp.com/sp-dev-list-formatting/@@SampleType@@-samples/@@SampleKey@@" />]]>
        </token>
      </tokens>
      <conditions>
        <filecontains path="@@READMEPath@@" text="@@TelemetryTag@@"/>
      </conditions>
    </rule>
    
  </rules>
</inspection>