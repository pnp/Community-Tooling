<?xml version="1.0" encoding="utf-8" ?>

<inspection>
  <tokens>
    <token name="ColumnSchema" value="https://developer.microsoft.com/json-schemas/sp/v2/column-formatting.schema.json"/>
    <token name="ViewSchema" value="https://developer.microsoft.com/json-schemas/sp/view-formatting.schema.json"/>
    <token name="TilesSchema" value="https://developer.microsoft.com/json-schemas/sp/v2/tile-formatting.schema.json"/>
  </tokens>

  <rules>
    <rule name="SampleContents" description="Validates the folders/files for a given sample">
      <tokens>
        <token name="whatever" value="$UPPER(@@fun@@)"/>
      </tokens>
      <conditions>
        <fileexists relativepath=""/>
      </conditions>
    </rule>

    <rule name="README_Exists" description="Verifies the README.md file exists">
      <conditions>
        <fileexists path="README.md"/>
        <fileexists path="README.md" matchcase="true" warn="true"/>
      </conditions>
    </rule>

    <rule name="AssetsFolder_Exists" description="Verifies the assets folder exists">
      <conditions>
        <folderexists path="assets"/>
        <folderexists path="assets" matchcase="true" warn="true"/>
      </conditions>
    </rule>

    <rule name="VerifySampleFiles" description="Makes sure base files exist">
      <conditions>
        <run rule="README_Exists"/>
        <run rule="Assets_Exists"/>
      </conditions>
    </rule>

    <rule name="ValidateSample" description="">
      <tokens>
        <token name="SampleKey" value="$IF($STARTSWITH(@@Each@@,#@@),#$DIRECTORYNAME(@@StartingPath@@),#@@Each@@)"/>
        <token name="FolderPath" value="$IF($STARTSWITH(@@ContainerPath@@,#@@),#@@StartingPath@@,#@@ContainerPath@@\@@Each@@)"/>
        <token name="MainJsonPath" value="@@FolderPath@@\@@SampleKey@@.json"/>
        <token name="READMEPath" value="@@FolderPath@@\README.md"/>
        <token name="AssetsPath" value="@@FolderPath@@\assets"/>
        <token name="SampleJsonPath" value="@@AssetsPath@@\sample.json"/>
        <token name="SampleType" value="$IF($CONTAINS(@@FolderPath@@,#\column-samples\),#Column,#$IF($CONTAINS(@@FolderPath@@,#\form-samples\),#Form,#View))"/>
        <token name="TelemetryTag">
          <![CDATA[<img src="https://telemetry.sharepointpnp.com/sp-dev-list-formatting/$LOWER(@@SampleType@@)-samples/@@SampleKey@@" />]]>
        </token>
      </tokens>
      <conditions>
        <fileexists path="@@MainJsonPath@@" failuremessage="Primary Sample JSON not found! (@@SampleKey@@)"/>
        <fileexists path="@@MainJsonPath@@" matchcase="true" warn="true"/>
        <fileexists path="@@READMEPath@@" failuremessage="README not found! (@@SampleKey@@)"/>
        <fileexists path="@@READMEPath@@" matchcase="true" warn="true"/>
        <folderexists path="@@AssetsPath@@" failuremessage="assets folder missing! (@@SampleKey@@)"/>
        <folderexists path="@@AssetsPath@@" matchcase="true" warn="true"/>
        <fileexists path="@@SampleJsonPath@@" failuremssage="sample.json not found! (@@SampleKey@@)"/>
        <fileexists path="@@SampleJsonPath@@" matchcase="true" warn="true"/>
        <or>
          <and>
            <fileexists path="@@AssetsPath@@\screenshot.png"/>
            <fileexists path="@@AssetsPath@@\screenshot.png" matchcase="true" warn="true"/>
          </and>
          <and>
            <fileexists path="@@AssetsPath@@\screenshot.gif"/>
            <fileexists path="@@AssetsPath@@\screenshot.gif" matchcase="true" warn="true"/>
          </and>
        </or>
        <filecontains path="@@READMEPath@@" text="@@TelemetryTag@@" matchcase="true" failuremessage="Telemetry Tag incorrect in README (@@SampleKey@@)"/>
        <or>
          <filecontains path="@@READMEPath@@" text="![screenshot of the sample](./assets/screenshot.png)" failuremessage="Screenshot not correctly referenced in README (@@SampleKey@@)"/>
          <filecontains path="@@READMEPath@@" text="![screenshot of the sample](./assets/screenshot.gif)" failuremessage="Screenshot not correctly referenced in README (@@SampleKey@@)"/>
        </or>
        <filecontains path="@@READMEPath@@" text="## Summary" failuremessage="README missing Summary section (@@SampleKey@@)"/>
        <filecontains path="@@READMEPath@@" text="## View requirements" failuremessage="README missing View requirements section (@@SampleKey@@)"/>
        <filecontains path="@@READMEPath@@" text="## Version history" failuremessage="README missing Version history section (@@SampleKey@@)"/>
      </conditions>
    </rule>

    <rule name="ValidateSamples">
      <conditions>
        <foreachfolder path="column-samples" pattern="date*">
          <run rule="ValidateSample"/>
        </foreachfolder>
      </conditions>
    </rule>

    <rule name="Screenshot" description="Verifies at least 1 screenshot exists (either gif or png)">
      <conditions>
        <or>
          <and>
            <fileexists path="assets/screenshot.png"/>
            <fileexists path="assets/screenshot.png" matchcase="true" warn="true"/>
          </and>
          <and>
            <fileexists path="assets/screenshot.gif"/>
            <fileexists path="assets/screenshot.gif" matchcase="true" warn="true"/>
          </and>
        </or>
      </conditions>
    </rule>

    <rule name="TelemetryLink">
      <tokens>
        <token name="SampleKey" value="$IF($STARTSWITH(@@Each@@,#@@),#$DIRECTORYNAME(@@StartingPath@@),#@@Each@@)"/>
        <token name="FolderPath" value="$IF($STARTSWITH(@@ContainerPath@@,#@@),#@@StartingPath@@,#@@ContainerPath@@\@@Each@@)"/>
        <token name="READMEPath" value="@@FolderPath@@\README.md"/>
        <token name="SampleType" value="$IF($CONTAINS(@@FolderPath@@,#\column-samples\),#Column,#$IF($CONTAINS(@@FolderPath@@,#\form-samples\),#Form,#View))"/>
        <token name="TelemetryTag">
          <![CDATA[<img src="https://telemetry.sharepointpnp.com/sp-dev-list-formatting/$LOWER(@@SampleType@@)-samples/@@SampleKey@@" />]]>
        </token>
      </tokens>
      <conditions>
        <filecontains path="@@READMEPath@@" text="@@TelemetryTag@@" matchcase="true" failuremessage="Telemetry Tag incorrect in README (@@SampleKey@@)"/>
        <or>
          <filecontains path="@@READMEPath@@" text="![screenshot of the sample](./assets/screenshot.png)" failuremessage="Screenshot not correctly referenced in README (@@SampleKey@@)"/>
          <filecontains path="@@READMEPath@@" text="![screenshot of the sample](./assets/screenshot.gif)" failuremessage="Screenshot not correctly referenced in README (@@SampleKey@@)"/>
        </or>
        <filecontains path="@@READMEPath@@" text="## Summary" failuremessage="README missing Summary section (@@SampleKey@@)"/>
        <filecontains path="@@READMEPath@@" text="## View requirements" failuremessage="README missing View requirements section (@@SampleKey@@)"/>
        <filecontains path="@@READMEPath@@" text="## Version history" failuremessage="README missing Version history section (@@SampleKey@@)"/>
      </conditions>
    </rule>

    <rule name="JsonValidate">
      <tokens>
        <token name="SampleKey" value="$IF($STARTSWITH(@@Each@@,#@@),#$DIRECTORYNAME(@@StartingPath@@),#@@Each@@)"/>
        <token name="FolderPath" value="$IF($STARTSWITH(@@ContainerPath@@,#@@),#@@StartingPath@@,#@@ContainerPath@@\@@Each@@)"/>
        <token name="MainJsonPath" value="@@FolderPath@@\@@SampleKey@@.json"/>
        <token name="READMEPath" value="@@FolderPath@@\README.md"/>
        <token name="AssetsPath" value="@@FolderPath@@\assets"/>
        <token name="SampleJsonPath" value="@@AssetsPath@@\sample.json"/>
        <token name="SampleType" value="$IF($CONTAINS(@@FolderPath@@,#\column-samples\),#Column,#$IF($CONTAINS(@@FolderPath@@,#\form-samples\),#Form,#View))"/>
        <token name="FormattedSchema">
          <![CDATA[{
  "$schema": "$IF($EQUALS(@@SampleType@@,#Column),#@@ColumnSchema@@,#@@ViewSchema@@)",]]>
        </token>
      </tokens>
      <conditions>
        <jsonquery path="@@SampleJsonPath@@" value="@@SampleType@@" query="$[0].metadata.[?(@.key=='LIST-SAMPLE-TYPE')].value" matchcase="true"/>
        <jsonquery path="@@SampleJsonPath@@" value="pnp-list-formatting-@@SampleKey@@" query="$[0].name" matchcase="true"/>
        <jsonquery path="@@SampleJsonPath@@" value="@@SampleKey@@" query="$[0].reponame" matchcase="true"/>
        <jsonquery path="@@SampleJsonPath@@" value="https://github.com/pnp/sp-dev-list-formatting/tree/master/$LOWER(@@SampleType@@)-samples/@@SampleKey@@" query="$[0].url" matchcase="true"/>
        <jsonquery path="@@SampleJsonPath@@" comparison="count" value="1" query="$[0].shortDescription"/>
        <jsonquery path="@@SampleJsonPath@@" comparison="count" value="1" query="$[0].title"/>
        <jsonquery path="@@SampleJsonPath@@" value="pnp" query="$[0].source" matchcase="true"/>
        <jsonquery path="@@SampleJsonPath@@" comparison="count" min="1" query="$.[0].authors.[*].name"/>
        <or>
          <jsonquery path="@@SampleJsonPath@@" value="https://raw.githubusercontent.com/pnp/List-Formatting/master/$LOWER(@@SampleType@@)-samples/@@SampleKey@@/assets/screenshot.png" query="$[0].thumbnails[0].url"/>
          <jsonquery path="@@SampleJsonPath@@" value="https://raw.githubusercontent.com/pnp/List-Formatting/master/$LOWER(@@SampleType@@)-samples/@@SampleKey@@/assets/screenshot.gif" query="$[0].thumbnails[0].url"/>
        </or>
        <filecontains path="@@MainJsonPath@@" text="@@FormattedSchema@@"/>
      </conditions>
    </rule>
    
  </rules>
</inspection>